#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* here is python script that caliculate the rand sequence */
/* of course, you can implement this using c*/
/* 
enc = [ 0x33, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x2a, 0x00, 0x00, 0x00, 0x93, 0x00, 0x00, 0x00, 0x7b, 0x00, 0x00, 0x00, 0x82, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x00, 0x00, 0xac, 0x00, 0x00, 0x00, 0x8e, 0x00, 0x00, 0x00, 0xf4, 0x00, 0x00, 0x00, 0xb1, 0x00, 0x00, 0x00, 0xcb, 0x00, 0x00, 0x00, 0x8d, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0xb7, 0x00, 0x00, 0x00, 0x67, 0x00, 0x00, 0x00, 0x96, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x81, 0x00, 0x00, 0x00, 0xd3, 0x00, 0x00, 0x00, 0xbc, 0x00, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x4b, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xed, 0x00, 0x00, 0x00, 0xfd, 0x00, 0x00, 0x00, 0xee, 0x00, 0x00, 0x00, 0x56, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x52, 0x00, 0x00, 0x00, 0xd5, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x6d, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x7a, 0x00, 0x00, 0x00, 0x1b, 0x00, 0x00, 0x00, 0x69, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0xb6, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00, 0xbc, 0x00, 0x00, 0x00, 0x98, 0x00, 0x00, 0x00, 0xd1, 0x00, 0x00, 0x00, 0xa6, 0x00, 0x00, 0x00, 0x83, 0x00, 0x00, 0x00, 0xe9, 0x00, 0x00, 0x00, 0xeb, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x00, 0x00, 0x79, 0x00, 0x00, 0x00, 0x53, 0x00, 0x00, 0x00, 0x4f, 0x00, 0x00, 0x00, 0xa1, 0x00, 0x00, 0x00 ]

known_flag = "TBTL{"

print(f"rand sequence: {[enc[i*4] ^ ord(c) for i, c in enumerate(known_flag)]}")
*/

// brute force the seed, but in this case, the seed is first one
int main() {
    int seeds_to_try = 1000000;
    // get from above python script
    int expected_values[] = {103, 198, 105, 115, 81};
    int sequence_length = 5;
    int found = 0; 
    // get from Ghidra using LazyGhidra(convert_c_array_dword)
    unsigned int target[63] = {
    0x00000033, 0x00000084, 0x0000003D, 0x0000003F, 0x0000002A, 0x00000093, 0x0000007B, 0x00000082, 
    0x0000001A, 0x000000AC, 0x0000008E, 0x000000F4, 0x000000B1, 0x000000CB, 0x0000008D, 0x00000021, 
    0x0000000E, 0x000000B7, 0x00000067, 0x00000096, 0x0000002C, 0x00000081, 0x000000D3, 0x000000BC, 
    0x00000029, 0x0000006C, 0x0000004B, 0x0000000D, 0x00000000, 0x000000ED, 0x000000FD, 0x000000EE, 
    0x00000056, 0x00000040, 0x00000052, 0x000000D5, 0x00000005, 0x0000006D, 0x00000090, 0x0000003E, 
    0x0000007A, 0x0000001B, 0x00000069, 0x00000023, 0x0000001F, 0x000000B6, 0x0000001D, 0x000000BC, 
    0x00000098, 0x000000D1, 0x000000A6, 0x00000083, 0x000000E9, 0x000000EB, 0x00000013, 0x00000021, 
    0x0000003D, 0x000000F8, 0x0000002B, 0x00000079, 0x00000053, 0x0000004F, 0x000000A1
};
    char flag[64] = "TBTL{";

    for (int seed = 0; seed < seeds_to_try; seed++) {
        srand(seed);
        int match = 1;
        for (int i = 0; i < sequence_length; i++) {
            int tmp = rand() % 256;
            if (tmp != expected_values[i]) {
                match = 0;
                break;
            }
        }
        if (match) {
            for (int i = 5; i < 63; i++) {
                flag[i] = '\0';
            }
            flag[63] = '\0';            
            printf("Found a matching seed: %d\n", seed);
            for (int i = sequence_length; i<63; i++) {
                flag[i] = (char) target[i] ^ (rand() % 256);               
            }
            found = 1;
            break; 
        }
    }

    if (!found) {
        printf("No matching seed found within the first %d seeds.\n", seeds_to_try);
    }
    else {
        printf("Flag: %s\n", flag);
    }

    return 0;
}
